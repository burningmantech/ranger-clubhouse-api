#!/bin/sh
#
# Dispatcher for Travis CI
#

. "$(dirname "$0")/.common.sh";

echo "Environment:";
env;

docker_cache="${HOME}/docker_images";
cached_image="${docker_cache}/${TRAVIS_COMMIT}.image";

case "${TRAVIS_ACTION:=}" in
    "test")
        # Lint doesn't require a build and is a relatively quick check
        "${wd}/bin/test_lint" .;
        # Build and run tests
        "${wd}/bin/build";
        "${wd}/bin/test_docker";
        # Cache docker image for later use
        echo "Caching docker image...";
        mkdir -p "${docker_cache}";
        docker save "${image_name}" | gzip > "${cached_image}";
        ;;
    "deploy")
        # Use cached docker image (if available) or build, then deploy
        if [ -f "${cached_image}" ]; then
            echo "Loading cached docker image...";
            docker load < "${cached_image}";
        else
            echo "No cached docker image; building...";
            echo "Caches:";
            ls -l "${docker_cache}" || true;
            "${wd}/bin/build";
        fi;
        "${wd}/bin/deploy";
        ;;
    *)
        echo "Unknown Travis action: ${TRAVIS_ACTION}";
        exit 1;
        ;;
esac;
