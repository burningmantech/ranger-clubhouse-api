#!/bin/sh
#
# Dispatcher for Travis CI
#

. "$(dirname "$0")/.common.sh";

travis_action="${1}"; shift;

echo "Docker configuration:";
docker info;

echo "Environment:";
env;

docker_cache="${HOME}/docker_images";


cache() {
    local name="${1}"; shift;

    mkdir -p "${docker_cache}";

    echo "Caching Docker image: ${name}";
    docker save "${name}" | gzip -9 > "${docker_cache}/${name}.tgz";
}


load() {
    local name="${1}"; shift;

    if [ -f "${docker_cache}/${name}.tgz" ]; then
        echo "Loading Docker image from cache: ${name}";
        docker load < "${docker_cache}/${name}.tgz";
    else
        echo "No cached Docker image available: ${name}";
    fi;
}


case "${travis_action}" in

    "test")
        # Lint doesn't require a build and is a relatively quick check
        "${wd}/bin/test_lint" .;

        # Load cached docker images
        load "${php_image_name}";
        load "${composer_image_name}";

        # Build
        "${wd}/bin/build";

        # Run unit tests
        echo "Running unit tests...";
        "${wd}/bin/test_unit";

        # Run basic tests on the Docker container
        echo "Testing Docker image...";
        "${wd}/bin/test_docker";

        # Cache stable docker images for later use
        cache "${php_image_name}";
        cache "${composer_image_name}";
        ;;

    "deploy")
        if [ "${TRAVIS_PULL_REQUEST:-}" != "false" ]; then
            echo "No deploy from a pull request branch.";
            exit 0;
        fi;
        if [ "${TRAVIS_BRANCH}" != "master" ]; then
            echo "No deploy from non-master branch branch. Aborting.";
            exit 1;
        fi;

        # Load cached docker images
        load "${php_image_name}";
        load "${composer_image_name}";

        "${wd}/bin/build";

        # Deploy
        "${wd}/bin/deploy" staging;
        ;;

    *)
        echo "Unknown Travis action: ${travis_action}";
        exit 1;
        ;;

esac;
