#!/bin/sh
#
# Dispatcher for Travis CI
#

wd="$(cd "$(dirname "$0")/.." && pwd)";

echo "Environment:";
env;

cached_image="docker/${TRAVIS_COMMIT}.tgz";

case "${TRAVIS_ACTION:=}" in
    "lint")
        "${wd}/bin/test_lint" .;
        ;;
    "docker")
        "${wd}/bin/build";
        "${wd}/bin/test_docker";
        mkdir -p docker;
        docker save "${image_name}" | gzip -9 > "${cached_image}";
        ;;
    "deploy")
        if [ -f "${cached_image}" ]; then
            docker load < "${cached_image}";
        else
            "${wd}/bin/build";
        fi;
        "${wd}/bin/deploy";
        ;;
    *)
        echo "Unknown Travis action: ${TRAVIS_ACTION}";
        exit 1;
        ;;
esac;
