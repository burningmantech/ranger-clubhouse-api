#!/usr/bin/env python3

from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from html import escape
from os import environ
from smtplib import SMTP_SSL as SMTP
from ssl import create_default_context as SSLContext



class Notifier(object):
    def __init__(
        self,
        emailHost: str, emailPort: int, emailUser: str, emailPassword: str,
        emailSender: str, emailDestination: str,
    ) -> None:
        self.emailHost        = emailHost
        self.emailPort        = emailPort
        self.emailUser        = emailUser
        self.emailPassword    = emailPassword
        self.emailSender      = emailSender
        self.emailDestination = emailDestination


    def notifyStaging(
        self,
        project: str, repository: str, buildNumber:str, buildURL: str,
        pullRequestID: str, pullRequestURL: str,
        commitID: str, commitMessage: str,
    ):
        title = f"{project} Deployed to Staging"

        message = MIMEMultipart("alternative")
        message["Subject"] = title
        message["From"] = self.emailSender
        message["To"] = self.emailDestination

        commitURL = f"https://github.com/{repository}/commit/{commitID}"

        text = (
            f"Travis build #{buildNumber} for commit {commitID} "
            f"has completed successfully and the resulting image has been "
            f"deployed to the staging environment."
        )
        text = (
f"""
{title}

{text}

{commitMessage}

Diff: {commitURL}
Build log: {buildURL}
"""
        )[1:-1]
        html = (
f"""
<html>
  <head>{escape(title)}</head>
<body>

  <h1>{escape(title)}</h1>

  <p>
    <a href="{buildURL}">Travis build #{escape(buildNumber)}</a>
    for <a href="{commitURL}">commit {commitID}</a>
    has completed successfully and the resulting image has been has been
    deployed to the staging environment.
  </p>

  <blockquote>{escape(commitMessage)}</blockquote>
</body>
</html>
"""
        )[1:-1]

        message.attach(MIMEText(text, "plain"))
        message.attach(MIMEText(html, "html"))

        context = SSLContext()
        with SMTP(self.emailHost, self.emailPort, context=context) as relay:
            relay.login(self.emailUser, self.emailPassword)
            relay.sendmail(
                self.emailSender, self.emailDestination, message.as_string()
            )


if __name__ == "__main__":
    from sys import argv, exit, stderr

    argv = argv[1:]

    if len(argv) < 1:
        print("No environment specified", file=stderr)
        exit(64)  # EX_USAGE

    environment = argv.pop(0)

    if argv:
        print("Too many arguments", file=stderr)
        exit(64)  # EX_USAGE

    repository = environ.get("TRAVIS_REPO_SLUG", "<org>/<repo>")
    if repository:
        project = repository.split("/")[-1]
    else:
        project = "<project>"

    pullRequestID = environ.get("TRAVIS_PULL_REQUEST", "0")
    if pullRequestID and pullRequestID != "false":
        if repository:
            pullRequestURL = (
                f"https://github.com/{repository}/pull/{pullRequestID}"
            )
        else:
            pullRequestURL = "#pr"
    else:
        pullRequestID = "<pull request ID>"
        pullRequestURL = "#PR"

    notifier = Notifier(
        emailHost=environ.get("NOTIFY_SMTP_HOST", "localhost"),
        emailPort=int(environ.get("NOTIFY_SMTP_PORT", "465")),
        emailUser=environ.get("NOTIFY_SMTP_USER", "*"),
        emailPassword=environ.get("NOTIFY_SMTP_PASSWORD", "*"),
        emailSender=environ.get("NOTIFY_EMAIL_SENDER", "sender@example.com"),
        emailDestination=environ.get(
            "NOTIFY_EMAIL_RECIPIENT", "recipient@example.com"
        ),
    )

    if environment == "staging":
        notifier.notifyStaging(
            project=project,
            repository=repository,
            buildNumber=environ.get("TRAVIS_BUILD_NUMBER", "<build ID>"),
            buildURL=environ.get("TRAVIS_BUILD_WEB_URL", "#build"),
            pullRequestID=pullRequestID,
            pullRequestURL=pullRequestURL,
            commitID=environ.get("TRAVIS_COMMIT", "<commit ID>"),
            commitMessage=environ.get("TRAVIS_COMMIT_MESSAGE", "<message>"),
        )
